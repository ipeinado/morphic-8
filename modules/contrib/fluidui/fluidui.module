<?php
/**
 * @file
 * This module adds the Fluidproject UI Options project library to your site.
 */

/**
 * Implements template_preprocess_page().
 */
function fluidui_preprocess_page(&$variables)
{
    $route = \Drupal::routeMatch()->getRouteObject();

    $is_admin = \Drupal::service('router.admin_context')->isAdminRoute($route);

    if (!$is_admin) {
        $variables['page']['#cache']['contexts'][] = 'fluidui';
        $variables['#attached']['library'][] = 'fluidui/fluidui.infusion';
    }

    $module_path = drupal_get_path('module', 'fluidui');

    $variables['#attached']['drupalSettings']['modulePath'] = $module_path;
}

/**
 * Implements template_preprocess_html().
 */
function fluidui_preprocess_html(&$variables){
  //read the fluid cookie first
  if (isset($_COOKIE['fluid-ui-settings'])){
    $vals = (array) json_decode($_COOKIE['fluid-ui-settings']);

    if (isset($vals['preferences']->fluid_prefs_contrast)){
        $variables['attributes']['class'][] = 'fl-theme-' . $vals['preferences']->fluid_prefs_contrast;
    }

    if (isset($vals['preferences']->fluid_prefs_enhanceInputs)){
        $variables['fl-input-enhanced']['class'][] = 'fl-input-enhanced';
    }

    if (isset($vals['preferences']->fluid_prefs_textFont)){
        $variables['attributes']['class'][] = 'fl-font-' . $vals['preferences']->fluid_prefs_textFont;
    }

    if (isset($vals['preferences']->fluid_prefs_lineSpace)){
        $variables['attributes']['style']['line-height'] = 3;
    }
  }
}

/**
 * Implements hook_page_top().
 */
function fluidui_page_top(array &$page_top) {
    $route = \Drupal::routeMatch()->getRouteObject();
    $is_admin = \Drupal::service('router.admin_context')->isAdminRoute($route);
    if (!$is_admin) {
        $page_top['fluidui'] = [
            '#theme' => 'fluid_ui_block',
        ];
    }
}

/**
 * Implements hook_theme().
 */
function fluidui_theme() {
    return [
        'fluid_ui_block' => [
            'render element' => 'content',
        ],
    ];
}